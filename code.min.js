const live=document.querySelector("#live"),run=document.querySelector("#run"),copy=document.querySelector("#copy"),result=document.querySelector(".result-code"),source=document.querySelector(".source-code");let currentCode,gutterCounter=1;function getCurrentCode(){const[...e]=document.querySelectorAll(".source-code .code");return e.map((e=>{if(""!==e.textContent)return e})).at(-1).textContent}function keyPressHandler(e){const t=e.target;if("Enter"===e.key)createLine(source,t),""!==t.textContent&&parseCode(t.textContent);else if("Backspace"===e.key&&""===t.textContent&&t.previousElementSibling.innerText>1)setCursor(t.parentElement.previousElementSibling.children[1]),t.parentElement.remove(),gutterCount(".source-code .gutter");else if("ArrowUp"===e.key)try{setCursor(t.parentElement.previousElementSibling.children[1])}catch(e){}else if("ArrowDown"===e.key)try{setCursor(t.parentElement.nextElementSibling.children[1])}catch(e){}}function createLine(e,t,n=""){const r=document.createElement("div");r.className="line";const l=document.createElement("span");l.className="gutter",e===source?(t||(l.innerText=1),t&&(l.innerText=++t.previousElementSibling.textContent)):e===result&&(l.innerText=gutterCounter++);const c=document.createElement("code");c.className="code",e===source&&c.setAttribute("contenteditable",!0),e===result&&(c.textContent=n),c.setAttribute("spellcheck",!1),c.addEventListener("keydown",(e=>{keyPressHandler(e)})),r.append(l,c),t?t&&(t.parentElement.after(r),gutterCount(".source-code .gutter")):e.append(r),c.focus()}function gutterCount(e){document.querySelectorAll(e).forEach(((e,t)=>{e.innerText=++t}))}function setCursor(e){e.focus();const t=new Range;t.selectNodeContents(e),t.collapse(!1),document.getSelection().empty(),document.getSelection().addRange(t)}createLine(source),live.addEventListener("click",(()=>{live.classList.toggle("active"),live.classList.contains("active")?lineBreaking("Live mode is under development"):(result.replaceChildren(),gutterCounter=1)})),run.addEventListener("mouseover",(()=>{"code"===document.activeElement.localName?currentCode=document.activeElement.textContent:currentElement=getCurrentCode()})),run.addEventListener("click",(()=>{""!==currentCode&&parseCode(currentCode)})),copy.addEventListener("click",(()=>{if("Range"===document.getSelection().type)document.getSelection(),document.execCommand("copy"),document.getSelection().empty();else{const e=new Range;e.selectNodeContents(result),document.getSelection().addRange(e),document.execCommand("copy"),document.getSelection().removeAllRanges()}}));class Element{constructor(e={}){this.element=document.createElement(e.name||"div"),this.id=e.id,this.class=e.class,this.attr=e.attr||[],this.children=e.children||[],this.content=e.content,this.element.level=e.level||0,this.build()}build(){this.id&&(this.element.id=this.id),this.class&&(this.element.className=this.class),this.attr&&Array.isArray(this.attr)&&this.attr.forEach((e=>{if("string"==typeof e){let t=e.split("=");this.element.setAttribute(t[0],t[1]??"")}})),this.element.content=this.content,this.children&&Array.isArray(this.children)&&this.children.forEach((e=>{const t=new Element(e);this.element.append(t.element)}))}render(){const e="    ",t=/<[^<>]+>/g;let n="";return function r(l){const[...c]=l.children;c.forEach((l=>{const c=l.outerHTML.match(t)[0],i=l.outerHTML.match(t).at(-1);let s;l.content&&(s=l.content),0===l.children.length&&s&&s.length<25?n+=`${e.repeat(l.level-1)}${c}${s}${i}\n`:l.children.length>0&&!s?(n+=`${e.repeat(l.level-1)}${c}\n`,r(l),n+=`${e.repeat(l.level-1)}${i}\n`):l.children.length>0&&s?(n+=`${e.repeat(l.level-1)}${c}\n`,n+=`${e.repeat(l.level)}${s}\n`,r(l),n+=`${e.repeat(l.level-1)}${i}\n`):0===l.children.length&&s&&s.length>25?(n+=`${e.repeat(l.level-1)}${c}\n`,n+=`${e.repeat(l.level)}${s}\n`,n+=`${e.repeat(l.level-1)}${i}\n`):0!==l.children.length||s||(n+=`${e.repeat(l.level-1)}${c}${i}\n`)}))}(this.element),n}}function lineBreaking(e){e&&"string"==typeof e?e.split("\n").forEach((e=>{createLine(result,"",e)})):console.log("Incorrect data in lineBreaking()")}function parseCode(e){if(e&&"string"==typeof e){if(e){const t=/\^+/g,n={};let r=n;r.level=0;e.split(">").forEach((e=>{if(r.children=[],e.includes("+")){if(e.includes("+")){e.split("+").forEach(((e,l,c)=>{if(e.includes("^")){if(e.includes("^")){const i=t.exec(e).index,s=e.match(t)[0].length,o=e.substring(0,i),a=e.substring(i+s),u=parseElement(o,r.level);r.children.push(u);const d=r.level-s;r=findParentObject(n,d);const h=parseElement(a,r.level);r.children.push(h),l===c.length-1&&(r=h)}}else{const t=parseElement(e,r.level);r.children.push(t),l===c.length-1&&(r=t)}}))}}else if(e.includes("^")){if(e.includes("^")){const l=t.exec(e).index,c=e.match(t)[0].length,i=e.substring(0,l),s=e.substring(l+c),o=parseElement(i,r.level);r.children.push(o);const a=r.level-c;r=findParentObject(n,a);const u=parseElement(s,r.level);r.children.push(u),r=u}}else{const t=parseElement(e,r.level);r.children.push(t),r=t}})),lineBreaking(new Element(n).render())}}else console.log("The function 'parseCode' received incorrect data, the data must have type 'string'")}function findParentObject(e,t){let n,r;return t>=0?n=t:(lineBreaking("You made a mistake in raising the levels, check your code, level is set to the lowest possible"),n=0),e.level===n?r=e:e.children&&e.children.forEach((e=>{r=findParentObject(e,n)})),r}function parseElement(e,t){if(e&&"string"==typeof e){if(e){const n=/^[a-z].*?(?=\.|#|\[|{|$)/,r=/[.].*?(?=#|\[|{|$)/,l=/[#].*?(?=\.|\[|{|$)/,c=/[\[].*[\]]/,i=/[{].*[}]/,s={};return e.match(n)&&(s.name=e.match(n).toString()),e.match(r)&&(s.class=e.match(r).toString().replaceAll("."," ").trim()),e.match(l)&&(s.id=e.match(l).toString().slice(1)),e.match(c)&&(s.attr=e.match(c).toString().slice(1,-1).split(" ")),e.match(i)&&(s.content=e.match(i).toString().slice(1,-1)),s.level=++t,s}}else console.log("The function 'parseElement' received incorrect data, the data must have type 'string'")}